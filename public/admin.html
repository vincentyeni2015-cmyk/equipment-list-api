<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Equipment List Admin - Union Filters</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#333;line-height:1.5}
    .admin-header{background:linear-gradient(135deg,#1f2937,#374151);color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-top{display:flex;justify-content:space-between;align-items:center;padding:16px 30px;border-bottom:1px solid rgba(255,255,255,.1)}
    .header-top h1{font-size:18px;font-weight:600;display:flex;align-items:center;gap:10px}
    .header-top h1 span{background:#F7B910;color:#000;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700}
    .header-actions{display:flex;gap:10px}
    .header-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;transition:all .2s}
    .header-btn:hover{background:rgba(255,255,255,.2)}
    .header-nav{display:flex;padding:0 30px}
    .nav-tab{padding:14px 20px;color:rgba(255,255,255,.7);text-decoration:none;font-size:14px;font-weight:500;border-bottom:3px solid transparent;cursor:pointer}
    .nav-tab:hover{color:#fff;background:rgba(255,255,255,.05)}
    .nav-tab.active{color:#fff;border-bottom-color:#F7B910}
    .admin-container{max-width:1400px;margin:0 auto;padding:30px}
    .config-panel{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);display:none;border-left:4px solid #F7B910}
    .config-panel.show{display:block}
    .config-panel h3{margin-bottom:16px;font-size:16px}
    .config-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
    .config-row label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:#666}
    .config-row input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .config-row input:focus{outline:none;border-color:#F7B910;box-shadow:0 0 0 3px rgba(247,185,16,.15)}
    .config-actions{display:flex;gap:10px;margin-top:16px}
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
    .stat-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1);position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:#F7B910}
    .stat-card.blue::before{background:#3b82f6}
    .stat-card.green::before{background:#10b981}
    .stat-card.purple::before{background:#8b5cf6}
    .stat-card .stat-icon{font-size:24px;margin-bottom:8px}
    .stat-card .stat-value{font-size:32px;font-weight:700;color:#1f2937}
    .stat-card .stat-label{font-size:13px;color:#6b7280;margin-top:4px}
    .search-section{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .search-bar{display:flex;gap:12px}
    .search-input-wrapper{flex:1;position:relative}
    .search-input-wrapper svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#9ca3af}
    .search-bar input{width:100%;padding:12px 16px 12px 44px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    .search-bar input:focus{outline:none;border-color:#F7B910}
    .customers-panel{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #eee;background:#f9fafb;border-radius:12px 12px 0 0}
    .panel-header h2{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}
    .panel-header .count-badge{background:#F7B910;color:#000;padding:2px 8px;border-radius:10px;font-size:12px;font-weight:600}
    .customers-table{width:100%;border-collapse:collapse}
    .customers-table th{text-align:left;padding:14px 16px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#6b7280;background:#f9fafb;border-bottom:1px solid #eee}
    .customers-table td{padding:16px;border-bottom:1px solid #f3f4f6;font-size:14px}
    .customers-table tbody tr:hover{background:#fefce8}
    .customer-cell{display:flex;align-items:center;gap:12px}
    .customer-avatar{width:40px;height:40px;background:linear-gradient(135deg,#F7B910,#f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#000;font-size:14px;flex-shrink:0}
    .customer-avatar.no-name{background:linear-gradient(135deg,#6b7280,#4b5563);color:#fff}
    .customer-info .customer-name{font-weight:600;color:#1f2937}
    .customer-info .customer-email{color:#6b7280;font-size:13px}
    .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500}
    .badge-count{background:#dbeafe;color:#1e40af}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:all .15s}
    .btn-sm{padding:8px 14px;font-size:13px}
    .btn-primary{background:#F7B910;color:#000}
    .btn-primary:hover{background:#d9a00e}
    .btn-secondary{background:#f3f4f6;color:#374151}
    .btn-secondary:hover{background:#e5e7eb}
    .btn-outline{background:#fff;border:1px solid #ddd;color:#374151}
    .btn-outline:hover{border-color:#F7B910;color:#F7B910}
    .btn-success{background:#10b981;color:#fff}
    .btn-danger{background:#fee2e2;color:#dc2626}
    .btn-danger:hover{background:#fecaca}
    
    /* FIXED: Dropdown styles */
    .dropdown{position:relative;display:inline-block}
    .dropdown-menu{position:absolute;top:100%;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.15);min-width:200px;z-index:9999;display:none;margin-top:4px}
    .dropdown-menu.show{display:block}
    .dropdown-menu.dropup{bottom:100%;top:auto;margin-bottom:4px;margin-top:0}
    .dropdown-item{display:flex;align-items:center;gap:8px;padding:12px 16px;font-size:14px;color:#374151;cursor:pointer;transition:background .15s;white-space:nowrap}
    .dropdown-item:first-child{border-radius:8px 8px 0 0}
    .dropdown-item:last-child{border-radius:0 0 8px 8px}
    .dropdown-item:hover{background:#f3f4f6}
    
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;width:100%;max-width:1000px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,.25)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #eee;background:#f9fafb}
    .modal-header h2{font-size:18px;font-weight:600}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#999;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:#f3f4f6;color:#333}
    .modal-body{padding:24px;overflow-y:auto;flex:1}
    /* FIXED: Modal footer overflow for dropup */
    .modal-footer{padding:16px 24px;border-top:1px solid #eee;background:#f9fafb;display:flex;justify-content:space-between;gap:12px;overflow:visible;position:relative}
    .modal-footer-left,.modal-footer-right{display:flex;gap:10px}
    .customer-detail-header{display:flex;gap:20px;margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid #eee}
    .customer-detail-avatar{width:80px;height:80px;background:linear-gradient(135deg,#F7B910,#f59e0b);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;color:#000;flex-shrink:0}
    .customer-detail-avatar.no-name{background:linear-gradient(135deg,#6b7280,#4b5563);color:#fff}
    .customer-detail-info h3{font-size:22px;margin-bottom:4px}
    .customer-detail-info p{color:#6b7280;font-size:14px;margin-bottom:4px}
    .customer-detail-info .customer-id{font-size:12px;color:#9ca3af;font-family:monospace}
    .customer-stats{display:flex;gap:24px;margin-top:12px}
    .customer-stat{display:flex;align-items:center;gap:6px;font-size:14px}
    .customer-stat strong{color:#1f2937}
    .equipment-section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .equipment-section-header h4{font-size:16px;font-weight:600}
    .equipment-list-admin{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .equipment-list-admin table{width:100%;border-collapse:collapse;font-size:13px}
    .equipment-list-admin th{text-align:left;padding:12px 14px;background:#f9fafb;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:#6b7280;border-bottom:1px solid #e5e7eb}
    .equipment-list-admin td{padding:12px 14px;border-bottom:1px solid #f3f4f6}
    .equipment-list-admin tr:last-child td{border-bottom:none}
    .equipment-list-admin tr:hover{background:#fefce8}
    .favorite-star{color:#fbbf24;font-size:16px}
    .equipment-name{font-weight:600;color:#1f2937}
    .equipment-actions{display:flex;gap:6px}
    .equipment-actions .btn{padding:6px 10px;font-size:12px}
    .empty-state{text-align:center;padding:60px 20px;color:#6b7280}
    .empty-state h3{font-size:18px;color:#374151;margin-bottom:8px}
    .loading{text-align:center;padding:60px 20px;color:#6b7280}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:3px solid #f3f4f6;border-top-color:#F7B910;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .message{padding:16px 20px;border-radius:10px;margin-bottom:20px;display:flex;align-items:center;gap:12px;animation:slideDown .3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .message-error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .message-success{background:#ecfdf5;color:#059669;border:1px solid #a7f3d0}
    .message-info{background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe}
    .add-equipment-form,.import-section{background:#f9fafb;border-radius:12px;padding:20px;margin-top:20px;display:none}
    .add-equipment-form.show,.import-section.show{display:block}
    .add-equipment-form h4,.import-section h4{margin-bottom:16px;font-size:15px}
    .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .form-group label{display:block;font-size:12px;font-weight:500;margin-bottom:4px;color:#6b7280}
    .form-group input,.form-group select{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#F7B910}
    .form-actions,.import-actions{margin-top:16px;display:flex;gap:10px;justify-content:flex-end}
    .import-preview{margin-top:16px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e5e7eb;max-height:250px;overflow:auto}
    .import-preview table{width:100%;font-size:12px;border-collapse:collapse}
    .import-preview th,.import-preview td{padding:8px;text-align:left;border-bottom:1px solid #f3f4f6}
    .import-preview th{background:#f9fafb;font-weight:600;position:sticky;top:0}
    @media(max-width:1024px){.stats-row{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:768px){.admin-container{padding:15px}.header-top{flex-direction:column;gap:12px;text-align:center}.config-row,.stats-row{grid-template-columns:1fr}.search-bar{flex-direction:column}.form-grid{grid-template-columns:1fr}.customer-detail-header{flex-direction:column;text-align:center}.customer-stats{justify-content:center}.modal-footer{flex-direction:column}.modal-footer-left,.modal-footer-right{width:100%;justify-content:center}}
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="header-top">
      <h1>üîß Equipment List Admin <span>UNION FILTERS</span></h1>
      <div class="header-actions">
        <button class="header-btn" id="toggleConfig">‚öôÔ∏è Settings</button>
        <button class="header-btn" id="refreshAll">üîÑ Refresh</button>
      </div>
    </div>
    <nav class="header-nav">
      <a class="nav-tab active">üë• Customers</a>
      <a class="nav-tab">üìä Analytics</a>
    </nav>
  </header>

  <div class="admin-container">
    <div class="config-panel" id="configPanel">
      <h3>‚öôÔ∏è API Configuration</h3>
      <div class="config-row">
        <div><label>API Endpoint URL</label><input type="text" id="apiEndpoint" placeholder="/.netlify/functions/equipment-save"></div>
        <div><label>Store Domain</label><input type="text" id="storeDomain" placeholder="your-store.myshopify.com"></div>
      </div>
      <div class="config-actions">
        <button class="btn btn-primary" id="saveConfig">üíæ Save Configuration</button>
        <button class="btn btn-secondary" id="testConnection">üîó Test Connection</button>
      </div>
    </div>

    <div id="messageContainer"></div>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="totalCustomers">-</div><div class="stat-label">Customers with Equipment</div></div>
      <div class="stat-card blue"><div class="stat-icon">üöú</div><div class="stat-value" id="totalEquipment">-</div><div class="stat-label">Total Equipment Items</div></div>
      <div class="stat-card green"><div class="stat-icon">‚≠ê</div><div class="stat-value" id="totalFavorites">-</div><div class="stat-label">Favorited Items</div></div>
      <div class="stat-card purple"><div class="stat-icon">üìÖ</div><div class="stat-value" id="recentActivity">-</div><div class="stat-label">Updated This Week</div></div>
    </div>

    <div class="search-section">
      <div class="search-bar">
        <div class="search-input-wrapper">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" id="searchInput" placeholder="Search by customer name or email...">
        </div>
        <button class="btn btn-primary" id="searchBtn">üîç Search</button>
        <button class="btn btn-outline" id="clearSearch">Clear</button>
      </div>
    </div>

    <div class="customers-panel">
      <div class="panel-header">
        <h2>üìã Customer Equipment Lists <span class="count-badge" id="customerCount">0</span></h2>
        <div class="dropdown">
          <button class="btn btn-sm btn-secondary" id="exportAllBtn">üì• Export All ‚ñæ</button>
          <div class="dropdown-menu" id="exportAllMenu">
            <div class="dropdown-item" id="exportAllCSV">üìÑ Export as CSV</div>
            <div class="dropdown-item" id="exportAllJSON">üìã Export as JSON</div>
          </div>
        </div>
      </div>
      <div id="customersContainer"><div class="loading"><div class="loading-spinner"></div><p>Loading customers...</p></div></div>
    </div>
  </div>

  <div class="modal-overlay" id="customerModal">
    <div class="modal">
      <div class="modal-header"><h2>üìù Customer Equipment Details</h2><button class="modal-close" id="closeModal">&times;</button></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <div class="modal-footer-left">
          <button class="btn btn-secondary" id="addEquipmentBtn">‚ûï Add Equipment</button>
          <button class="btn btn-secondary" id="importEquipmentBtn">üì§ Import CSV</button>
        </div>
        <div class="modal-footer-right">
          <div class="dropdown">
            <button class="btn btn-outline" id="exportCustomerBtn">üì• Export ‚ñæ</button>
            <div class="dropdown-menu dropup" id="exportCustomerMenu">
              <div class="dropdown-item" id="exportCustomerCSV">üìÑ Export as CSV</div>
              <div class="dropdown-item" id="exportCustomerJSON">üìã Export as JSON</div>
            </div>
          </div>
          <button class="btn btn-secondary" id="closeModalBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width:400px">
      <div class="modal-header"><h2>‚ö†Ô∏è Confirm Delete</h2><button class="modal-close" id="closeDeleteModal">&times;</button></div>
      <div class="modal-body"><p>Are you sure you want to delete this equipment?</p><p><strong id="deleteItemName"></strong></p><p style="color:#dc2626;margin-top:12px">This action cannot be undone.</p></div>
      <div class="modal-footer"><div class="modal-footer-right" style="width:100%;justify-content:flex-end"><button class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button><button class="btn btn-danger" id="confirmDeleteBtn">üóëÔ∏è Delete</button></div></div>
    </div>
  </div>

  <input type="file" id="csvFileInput" accept=".csv" style="display:none">

  <script>
    let config = {
      apiEndpoint: localStorage.getItem('equipmentAdminEndpoint') || '/.netlify/functions/equipment-save',
      storeDomain: localStorage.getItem('equipmentAdminStore') || ''
    };
    let customers = [];
    let currentCustomer = null;
    let currentEquipment = null;
    let deleteTargetId = null;
    let importData = null;

    // FIXED: Better name/initials handling
    function getDisplayInfo(c) {
      const first = (c.firstName || '').trim();
      const last = (c.lastName || '').trim();
      const email = (c.email || '').trim();
      
      let name, initials, hasName = false;
      
      if (first || last) {
        name = (first + ' ' + last).trim();
        initials = (first ? first[0] : '') + (last ? last[0] : '');
        hasName = true;
      } else if (email) {
        name = email;
        initials = email.substring(0, 2);
      } else {
        name = 'Customer #' + (c.id ? c.id.toString().slice(-6) : '???');
        initials = '??';
      }
      
      return {
        name: name,
        initials: initials.toUpperCase(),
        email: email || 'No email',
        hasName: hasName
      };
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('apiEndpoint').value = config.apiEndpoint;
      document.getElementById('storeDomain').value = config.storeDomain;
      
      // Config
      document.getElementById('toggleConfig').onclick = () => document.getElementById('configPanel').classList.toggle('show');
      document.getElementById('saveConfig').onclick = saveConfig;
      document.getElementById('testConnection').onclick = testConnection;
      
      // Search
      document.getElementById('searchBtn').onclick = renderCustomers;
      document.getElementById('clearSearch').onclick = () => { document.getElementById('searchInput').value = ''; renderCustomers(); };
      document.getElementById('searchInput').onkeypress = e => { if (e.key === 'Enter') renderCustomers(); };
      document.getElementById('refreshAll').onclick = loadCustomers;
      
      // Dropdowns
      document.getElementById('exportAllBtn').onclick = e => { e.stopPropagation(); toggleDropdown('exportAllMenu'); };
      document.getElementById('exportCustomerBtn').onclick = e => { e.stopPropagation(); toggleDropdown('exportCustomerMenu'); };
      document.addEventListener('click', () => closeAllDropdowns());
      
      // Export actions
      document.getElementById('exportAllCSV').onclick = () => { closeAllDropdowns(); exportAllCSV(); };
      document.getElementById('exportAllJSON').onclick = () => { closeAllDropdowns(); exportAllJSON(); };
      document.getElementById('exportCustomerCSV').onclick = () => { closeAllDropdowns(); exportCustomerCSV(); };
      document.getElementById('exportCustomerJSON').onclick = () => { closeAllDropdowns(); exportCustomerJSON(); };
      
      // Modals
      document.getElementById('closeModal').onclick = closeModal;
      document.getElementById('closeModalBtn').onclick = closeModal;
      document.getElementById('customerModal').onclick = e => { if (e.target.id === 'customerModal') closeModal(); };
      document.getElementById('addEquipmentBtn').onclick = showAddForm;
      document.getElementById('importEquipmentBtn').onclick = () => document.getElementById('csvFileInput').click();
      document.getElementById('csvFileInput').onchange = handleCSVSelect;
      
      // Delete modal
      document.getElementById('closeDeleteModal').onclick = closeDeleteModal;
      document.getElementById('cancelDeleteBtn').onclick = closeDeleteModal;
      document.getElementById('confirmDeleteBtn').onclick = confirmDelete;
      document.getElementById('deleteModal').onclick = e => { if (e.target.id === 'deleteModal') closeDeleteModal(); };
      
      loadCustomers();
    });

    function toggleDropdown(id) {
      closeAllDropdowns();
      document.getElementById(id).classList.add('show');
    }
    
    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
    }

    function saveConfig() {
      config.apiEndpoint = document.getElementById('apiEndpoint').value.trim();
      config.storeDomain = document.getElementById('storeDomain').value.trim();
      localStorage.setItem('equipmentAdminEndpoint', config.apiEndpoint);
      localStorage.setItem('equipmentAdminStore', config.storeDomain);
      showMsg('Configuration saved!', 'success');
      loadCustomers();
    }

    async function testConnection() {
      showMsg('Testing connection...', 'info');
      try {
        const r = await fetch(config.apiEndpoint + '?action=list-customers&limit=1');
        showMsg(r.ok ? '‚úÖ Connection successful!' : '‚ùå Failed: HTTP ' + r.status, r.ok ? 'success' : 'error');
      } catch (e) {
        showMsg('‚ùå Failed: ' + e.message, 'error');
      }
    }

    async function loadCustomers() {
      document.getElementById('customersContainer').innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading customers...</p></div>';
      try {
        const r = await fetch(config.apiEndpoint + '?action=list-customers&limit=200');
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        customers = d.customers || [];
        updateStats();
        renderCustomers();
      } catch (e) {
        document.getElementById('customersContainer').innerHTML = '<div class="empty-state"><h3>Could not load customers</h3><p>Check your API configuration.</p></div>';
        showMsg('Error: ' + e.message, 'error');
      }
    }

    function updateStats() {
      document.getElementById('totalCustomers').textContent = customers.length;
      let total = 0;
      customers.forEach(c => total += c.equipmentCount || 0);
      document.getElementById('totalEquipment').textContent = total;
      document.getElementById('totalFavorites').textContent = '‚Äî';
      document.getElementById('recentActivity').textContent = '‚Äî';
    }

    function renderCustomers() {
      const search = document.getElementById('searchInput').value.toLowerCase().trim();
      let filtered = customers;
      if (search) {
        filtered = customers.filter(c => 
          (c.email || '').toLowerCase().includes(search) ||
          (c.firstName || '').toLowerCase().includes(search) ||
          (c.lastName || '').toLowerCase().includes(search)
        );
      }
      document.getElementById('customerCount').textContent = filtered.length;

      if (filtered.length === 0) {
        document.getElementById('customersContainer').innerHTML = '<div class="empty-state"><h3>No customers found</h3><p>' + (search ? 'Try a different search.' : 'No customers have saved equipment yet.') + '</p></div>';
        return;
      }

      let html = '<table class="customers-table"><thead><tr><th>Customer</th><th>Equipment</th><th>Updated</th><th>Actions</th></tr></thead><tbody>';
      filtered.forEach(c => {
        const info = getDisplayInfo(c);
        html += '<tr><td><div class="customer-cell"><div class="customer-avatar ' + (info.hasName ? '' : 'no-name') + '">' + esc(info.initials) + '</div><div class="customer-info"><div class="customer-name">' + esc(info.name) + '</div><div class="customer-email">' + esc(info.email) + '</div></div></div></td><td><span class="badge badge-count">üöú ' + (c.equipmentCount || 0) + ' items</span></td><td>‚Äî</td><td><button class="btn btn-sm btn-primary" onclick="viewCustomer(\'' + c.id + '\')">View / Edit</button></td></tr>';
      });
      html += '</tbody></table>';
      document.getElementById('customersContainer').innerHTML = html;
    }

    async function viewCustomer(id) {
      document.getElementById('modalBody').innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading...</p></div>';
      document.getElementById('customerModal').classList.add('show');
      try {
        const r = await fetch(config.apiEndpoint + '?action=get-customer&customerId=' + id);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        currentCustomer = d.customer || { id: id };
        currentEquipment = d.machines || [];
        renderDetail();
      } catch (e) {
        document.getElementById('modalBody').innerHTML = '<div class="message message-error">Failed: ' + esc(e.message) + '</div>';
      }
    }

    function renderDetail() {
      const info = getDisplayInfo(currentCustomer);
      const favCount = currentEquipment.filter(m => m.favorite).length;
      
      let html = '<div class="customer-detail-header"><div class="customer-detail-avatar ' + (info.hasName ? '' : 'no-name') + '">' + esc(info.initials) + '</div><div class="customer-detail-info"><h3>' + esc(info.name) + '</h3><p>üìß ' + esc(info.email) + '</p><p class="customer-id">ID: ' + esc(currentCustomer.id || '‚Äî') + '</p><div class="customer-stats"><div class="customer-stat"><span>üöú</span><strong>' + currentEquipment.length + '</strong> equipment</div><div class="customer-stat"><span>‚≠ê</span><strong>' + favCount + '</strong> favorites</div></div></div></div>';

      if (currentEquipment.length === 0) {
        html += '<div class="empty-state"><h3>No equipment saved</h3><p>This customer hasn\'t added any equipment yet.</p></div>';
      } else {
        html += '<div class="equipment-section-header"><h4>üìã Equipment List</h4></div><div class="equipment-list-admin"><table><thead><tr><th style="width:40px">‚òÖ</th><th>SKU/ID</th><th>Category</th><th>Make</th><th>Type/Year</th><th>Model</th><th>Serial</th><th style="width:80px">Actions</th></tr></thead><tbody>';
        currentEquipment.forEach(m => {
          const isHD = m.category === 'Heavy-Duty Machinery';
          html += '<tr><td>' + (m.favorite ? '<span class="favorite-star">‚òÖ</span>' : '') + '</td><td><span class="equipment-name">' + esc(m.name || '‚Äî') + '</span></td><td>' + esc(m.category || '‚Äî') + '</td><td>' + esc(m.make || '‚Äî') + '</td><td>' + esc(isHD ? (m.type || '‚Äî') : (m.year || '‚Äî')) + '</td><td>' + esc(m.model || '‚Äî') + '</td><td>' + esc(m.serial || '‚Äî') + '</td><td><button class="btn btn-danger btn-sm" onclick="showDeleteConfirm(\'' + m.id + '\',\'' + esc(m.name || 'this item') + '\')">üóëÔ∏è</button></td></tr>';
        });
        html += '</tbody></table></div>';
      }

      html += '<div class="add-equipment-form" id="addEquipmentForm"><h4>‚ûï Add New Equipment</h4><div class="form-grid"><div class="form-group"><label>SKU/ID *</label><input type="text" id="newName" placeholder="TRACTOR-01"></div><div class="form-group"><label>Category *</label><select id="newCategory"><option value="">Select...</option><option value="Heavy-Duty Machinery">Heavy-Duty Machinery</option><option value="Trucks">Trucks</option><option value="Automotive">Automotive</option></select></div><div class="form-group"><label>Make *</label><input type="text" id="newMake" placeholder="Kubota"></div><div class="form-group"><label>Type/Year *</label><input type="text" id="newTypeYear" placeholder="Tractors or 2020"></div><div class="form-group"><label>Model *</label><input type="text" id="newModel" placeholder="L3901"></div><div class="form-group"><label>Serial #</label><input type="text" id="newSerial" placeholder="Optional"></div></div><div class="form-actions"><button class="btn btn-secondary" onclick="hideAddForm()">Cancel</button><button class="btn btn-primary" onclick="saveNewEquip()">üíæ Save</button></div></div>';
      
      html += '<div class="import-section" id="importSection"><h4>üì§ Import from CSV</h4><div id="importPreview"></div><div class="import-actions"><button class="btn btn-secondary" onclick="hideImport()">Cancel</button><button class="btn btn-success" onclick="doImport()">‚úÖ Import</button></div></div>';

      document.getElementById('modalBody').innerHTML = html;
    }

    function showAddForm() { hideImport(); const f = document.getElementById('addEquipmentForm'); if (f) f.classList.add('show'); }
    function hideAddForm() { const f = document.getElementById('addEquipmentForm'); if (f) f.classList.remove('show'); }

    async function saveNewEquip() {
      const name = document.getElementById('newName').value.trim();
      const cat = document.getElementById('newCategory').value;
      const make = document.getElementById('newMake').value.trim();
      const ty = document.getElementById('newTypeYear').value.trim();
      const model = document.getElementById('newModel').value.trim();
      const serial = document.getElementById('newSerial').value.trim();

      if (!name || !cat || !make || !ty || !model) { showMsg('Please fill required fields', 'error'); return; }

      const eq = { id: 'eq_' + Date.now().toString(36) + Math.random().toString(36).substr(2,5), name, category: cat, make, model, serial, favorite: false, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
      if (cat === 'Heavy-Duty Machinery') eq.type = ty; else eq.year = ty;
      currentEquipment.push(eq);

      try {
        const r = await fetch(config.apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ customerId: currentCustomer.id, equipmentData: { machines: currentEquipment } }) });
        if (!r.ok) throw new Error('Failed');
        showMsg('Equipment added!', 'success');
        hideAddForm();
        renderDetail();
        const c = customers.find(x => x.id === currentCustomer.id);
        if (c) c.equipmentCount = currentEquipment.length;
        updateStats();
      } catch (e) {
        currentEquipment.pop();
        showMsg('Error: ' + e.message, 'error');
      }
    }

    function handleCSVSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const data = parseCSV(ev.target.result);
          if (data.length === 0) { showMsg('CSV is empty or invalid', 'error'); return; }
          importData = data;
          showImportPreview(data);
        } catch (err) { showMsg('CSV error: ' + err.message, 'error'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) return [];
      const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
      const map = { 'sku': 'name', 'sku/id': 'name', 'name': 'name', 'category': 'category', 'make': 'make', 'type': 'type', 'year': 'year', 'type/year': 'typeYear', 'model': 'model', 'serial': 'serial', 'serial #': 'serial', 'favorite': 'favorite' };
      const mapped = headers.map(h => map[h] || h);
      const results = [];
      for (let i = 1; i < lines.length; i++) {
        const vals = parseCSVLine(lines[i]);
        if (!vals.length) continue;
        const row = {};
        mapped.forEach((h, idx) => row[h] = vals[idx] || '');
        if (row.typeYear) { if (/^\d{4}$/.test(row.typeYear)) row.year = row.typeYear; else row.type = row.typeYear; delete row.typeYear; }
        if (row.name || row.make) results.push(row);
      }
      return results;
    }

    function parseCSVLine(line) {
      const result = []; let cur = '', inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') inQ = !inQ;
        else if (ch === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
        else cur += ch;
      }
      result.push(cur.trim());
      return result;
    }

    function showImportPreview(data) {
      hideAddForm();
      let html = '<p><strong>' + data.length + '</strong> items found:</p><table><thead><tr><th>SKU/ID</th><th>Category</th><th>Make</th><th>Type/Year</th><th>Model</th></tr></thead><tbody>';
      data.slice(0, 8).forEach(r => { html += '<tr><td>' + esc(r.name || '‚Äî') + '</td><td>' + esc(r.category || '‚Äî') + '</td><td>' + esc(r.make || '‚Äî') + '</td><td>' + esc(r.type || r.year || '‚Äî') + '</td><td>' + esc(r.model || '‚Äî') + '</td></tr>'; });
      if (data.length > 8) html += '<tr><td colspan="5" style="text-align:center;color:#999">... and ' + (data.length - 8) + ' more</td></tr>';
      html += '</tbody></table>';
      document.getElementById('importPreview').innerHTML = html;
      document.getElementById('importSection').classList.add('show');
    }

    function hideImport() { const s = document.getElementById('importSection'); if (s) s.classList.remove('show'); importData = null; }

    async function doImport() {
      if (!importData || !importData.length) return;
      const newEq = importData.map(r => ({ id: 'eq_' + Date.now().toString(36) + Math.random().toString(36).substr(2,5), name: r.name || '', category: r.category || 'Heavy-Duty Machinery', make: r.make || '', type: r.type || '', year: r.year || '', model: r.model || '', serial: r.serial || '', favorite: r.favorite === 'true' || r.favorite === 'yes', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }));
      currentEquipment = currentEquipment.concat(newEq);
      try {
        const r = await fetch(config.apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ customerId: currentCustomer.id, equipmentData: { machines: currentEquipment } }) });
        if (!r.ok) throw new Error('Failed');
        showMsg('Imported ' + newEq.length + ' items!', 'success');
        hideImport();
        renderDetail();
        const c = customers.find(x => x.id === currentCustomer.id);
        if (c) c.equipmentCount = currentEquipment.length;
        updateStats();
        renderCustomers();
      } catch (e) {
        currentEquipment = currentEquipment.slice(0, -newEq.length);
        showMsg('Error: ' + e.message, 'error');
      }
    }

    function showDeleteConfirm(id, name) { deleteTargetId = id; document.getElementById('deleteItemName').textContent = name; document.getElementById('deleteModal').classList.add('show'); }
    function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('show'); deleteTargetId = null; }

    async function confirmDelete() {
      if (!deleteTargetId || !currentCustomer) return;
      const idx = currentEquipment.findIndex(m => m.id === deleteTargetId);
      if (idx === -1) return;
      const removed = currentEquipment.splice(idx, 1)[0];
      try {
        const r = await fetch(config.apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ customerId: currentCustomer.id, equipmentData: { machines: currentEquipment } }) });
        if (!r.ok) throw new Error('Failed');
        showMsg('Deleted!', 'success');
        closeDeleteModal();
        renderDetail();
        const c = customers.find(x => x.id === currentCustomer.id);
        if (c) c.equipmentCount = currentEquipment.length;
        updateStats();
        renderCustomers();
      } catch (e) {
        currentEquipment.splice(idx, 0, removed);
        showMsg('Error: ' + e.message, 'error');
      }
    }

    function exportCustomerCSV() {
      if (!currentCustomer || !currentEquipment) return;
      const csv = toCSV(currentEquipment);
      const info = getDisplayInfo(currentCustomer);
      download(csv, 'equipment-' + info.name.replace(/[^a-z0-9]/gi, '-').substring(0, 20) + '.csv', 'text/csv');
      showMsg('CSV downloaded!', 'success');
    }

    function exportCustomerJSON() {
      if (!currentCustomer || !currentEquipment) return;
      const data = { customer: currentCustomer, machines: currentEquipment, exportDate: new Date().toISOString() };
      const info = getDisplayInfo(currentCustomer);
      download(JSON.stringify(data, null, 2), 'equipment-' + info.name.replace(/[^a-z0-9]/gi, '-').substring(0, 20) + '.json', 'application/json');
      showMsg('JSON downloaded!', 'success');
    }

    function exportAllCSV() {
      if (!customers.length) { showMsg('No customers', 'error'); return; }
      let csv = 'Customer ID,Email,First Name,Last Name,Equipment Count\n';
      customers.forEach(c => csv += '"' + (c.id || '') + '","' + (c.email || '') + '","' + (c.firstName || '') + '","' + (c.lastName || '') + '",' + (c.equipmentCount || 0) + '\n');
      download(csv, 'all-customers-' + new Date().toISOString().split('T')[0] + '.csv', 'text/csv');
      showMsg('CSV downloaded!', 'success');
    }

    function exportAllJSON() {
      if (!customers.length) { showMsg('No customers', 'error'); return; }
      const data = { exportDate: new Date().toISOString(), totalCustomers: customers.length, customers: customers };
      download(JSON.stringify(data, null, 2), 'all-customers-' + new Date().toISOString().split('T')[0] + '.json', 'application/json');
      showMsg('JSON downloaded!', 'success');
    }

    function toCSV(eq) {
      let csv = 'SKU/ID,Category,Make,Type/Year,Model,Serial #,Favorite\n';
      eq.forEach(m => {
        const ty = m.category === 'Heavy-Duty Machinery' ? (m.type || '') : (m.year || '');
        csv += [csvEsc(m.name), csvEsc(m.category), csvEsc(m.make), csvEsc(ty), csvEsc(m.model), csvEsc(m.serial), m.favorite ? 'yes' : 'no'].join(',') + '\n';
      });
      return csv;
    }

    function csvEsc(s) { if (!s) return ''; s = String(s); return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s; }
    function download(content, filename, mime) { const b = new Blob([content], { type: mime }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = filename; a.click(); URL.revokeObjectURL(u); }
    function closeModal() { document.getElementById('customerModal').classList.remove('show'); currentCustomer = null; currentEquipment = null; importData = null; }
    function showMsg(m, t) { const ic = t === 'error' ? '‚ùå' : t === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'; document.getElementById('messageContainer').innerHTML = '<div class="message message-' + t + '">' + ic + ' ' + esc(m) + '</div>'; setTimeout(() => { const el = document.querySelector('.message'); if (el) el.style.opacity = '0'; setTimeout(() => document.getElementById('messageContainer').innerHTML = '', 300); }, 4000); }
    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
  </script>
</body>
</html>
